<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Admin • Insert Item</title>
  <style>
    :root { --fg:#111; --muted:#666; --ok:#0a6; --err:#b00; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; max-width: 680px; margin: 32px auto; padding: 0 16px; color: var(--fg); }
    h1 { margin: 0 0 12px; }
    .card { border: 1px solid #e5e7eb; border-radius: 12px; padding: 16px; margin: 12px 0; }
    .row { display: grid; gap: 8px; margin: 8px 0; }
    label { font-size: 12px; color: var(--muted); }
    input, textarea, select, button { font: inherit; padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; }
    button { cursor: pointer; border: 0; background: #111; color: #fff; }
    .muted { color: var(--muted); }
    .msg { padding: 10px 12px; border-radius: 10px; border: 1px solid #d1d5db; background: #f9fafb; margin-top: 8px; white-space: pre-wrap; }
    .ok { border-color: #bde7d2; background: #eefbf4; color: var(--ok); }
    .err { border-color: #ffd1d1; background: #fff5f5; color: var(--err); }
    .hidden { display: none; }
    code { background: #f3f4f6; padding: 1px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h1>Admin • Insert</h1>
  <p class="muted">Insert items now!>

  <!-- CONFIG -->
  <script>
    window.__SUPABASE_URL__ = 'https://uwclseatqvcdjmgoyuae.supabase.co';
    window.__SUPABASE_ANON_KEY__ = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV3Y2xzZWF0cXZjZGptZ295dWFlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA3NTI4MDYsImV4cCI6MjA3NjMyODgwNn0.mb6FxWJgjvc2X-NQtBj5iOVtT5hBuxBFO80b0Fqhl3o';
  </script>

  <!-- LOGIN -->
  <div id="authCard" class="card">
    <h3>Sign in</h3>
    <div class="row"><label>Email</label><input id="email" type="email" autocomplete="username" required></div>
    <div class="row"><label>Password</label><input id="password" type="password" autocomplete="current-password" required></div>
    <button id="btnSignIn">Sign in</button>
    <div id="authMsg" class="msg hidden"></div>
  </div>

  <!-- INSERT -->
  <div id="insertCard" class="card hidden">
    <div class="row" style="margin-bottom:4px;">
      <strong id="whoami"></strong>
      <button id="btnSignOut" style="justify-self:flex-start;background:#444">Sign out</button>
    </div>
    <h3>Insert item</h3>

    <div class="row">
      <label>Desk</label>
      <select id="desk_select"><option value="">Loading…</option></select>
    </div>

    <div class="row"><label>Title (required)</label><input id="title" placeholder="e.g., Student ID"></div>
    <div class="row"><label>Description</label><textarea id="desc" rows="3" placeholder="Optional"></textarea></div>

    <div class="row">
      <label>Category</label>
      <select id="category_select">
        <option value="Electronics">Electronics</option>
        <option value="Clothing">Clothing</option>
        <option value="Bags">Bags</option>
        <option value="Wallets">Wallets</option>
        <option value="Keys">Keys</option>
        <option value="Cards">Cards</option>
        <option value="Jewelry">Jewelry</option>
        <option value="Documents">Documents</option>
        <option value="ID">ID</option>
        <option value="Other">Other</option>
      </select>
    </div>

    <div class="row"><label>Found location text</label><input id="found_loc" placeholder="Optional"></div>
    <div class="row"><label>Found date (YYYY-MM-DD)</label><input id="found_date" type="date"></div>
    <div class="row"><label>Photo (optional)</label><input id="photo" type="file" accept="image/*"></div>

    <button id="btnInsert">Insert</button>
    <div id="insMsg" class="msg hidden"></div>
  </div>

  <script type="module">
    import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

    const supabase = createClient(window.__SUPABASE_URL__, window.__SUPABASE_ANON_KEY__)

    // DOM
    const $ = (id) => document.getElementById(id)
    const authCard = $('authCard'), authMsg = $('authMsg'), btnSignIn = $('btnSignIn')
    const insertCard = $('insertCard'), whoami = $('whoami'), btnSignOut = $('btnSignOut')
    const desk_select = $('desk_select')
    const title = $('title'), desc = $('desc'), category_select = $('category_select'), found_loc = $('found_loc'), found_date = $('found_date')
    const photo = $('photo')
    const btnInsert = $('btnInsert'), insMsg = $('insMsg')

    const show = (el)=>el.classList.remove('hidden'); const hide=(el)=>el.classList.add('hidden')
    const msg = (el, text, ok=false)=>{ el.textContent = text; el.classList.toggle('ok', !!ok); el.classList.toggle('err', !ok); show(el) }

    // Staff check
    async function isStaff(uid){
      const { data, error } = await supabase.schema('public').from('staff_user').select('id').eq('id', uid).maybeSingle()
      if (error) throw error
      return !!data
    }

    async function loadDesks(){
      desk_select.innerHTML = '<option value="">Loading…</option>'
      const { data, error } = await supabase.schema('public').from('desk').select('id,name').order('name')
      if (error){ desk_select.innerHTML = '<option value="">Error loading desks</option>'; return }
      if (!data?.length){ desk_select.innerHTML = '<option value="">No desks found</option>'; return }
      desk_select.innerHTML = data.map(d=>`<option value="${d.id}">${d.name}</option>`).join('')
    }

    async function showInsert(session){
      whoami.textContent = `Signed in as ${session.user.email}`
      hide(authCard); hide(authMsg); show(insertCard)
      await loadDesks()
    }

    // Bootstrap existing session
    (async () => {
      const { data: { session } } = await supabase.auth.getSession()
      if (session) {
        try { if (await isStaff(session.user.id)) return showInsert(session); await supabase.auth.signOut() } catch {}
      }
      show(authCard)
    })()

    // Sign in
    btnSignIn.addEventListener('click', async () => {
      hide(authMsg)
      const email = $('email').value.trim(); const password = $('password').value
      if (!email || !password) return msg(authMsg, 'Enter email and password.')
      const { data, error } = await supabase.auth.signInWithPassword({ email, password })
      if (error) return msg(authMsg, 'Sign-in error: ' + error.message)
      try {
        const ok = await isStaff(data.session.user.id)
        if (!ok) { await supabase.auth.signOut(); return msg(authMsg, 'Signed in but not in staff_user.', false) }
        await showInsert(data.session)
      } catch (e) { msg(authMsg, 'Staff check failed: ' + e.message) }
    })

    // Sign out
    btnSignOut.addEventListener('click', async () => {
      await supabase.auth.signOut(); hide(insertCard); show(authCard)
    })

    // INSERT (desk by dropdown UUID; category by dropdown)
    btnInsert.addEventListener('click', async () => {
      hide(insMsg)
      const deskId = (desk_select.value || '').trim()  // UUID string
      const t = (title.value || '').trim()
      const d = (desc.value || '').trim() || null
      const c = (category_select.value || '').trim() || null
      const fl = (found_loc.value || '').trim() || null
      const fd = found_date.value ? found_date.value : null  // DATE column

      if (!deskId) return msg(insMsg, 'Choose a desk.')
      if (!t) return msg(insMsg, 'Title is required.')

      try {
        // Insert item
        const { data: itemRow, error: insErr } = await supabase
          .schema('public')
          .from('item')
          .insert({ desk_id: deskId, title: t, description: d, category: c, found_date: fd, found_location_text: fl })
          .select('id')
          .maybeSingle()
        if (insErr) throw insErr
        if (!itemRow) throw new Error('Insert returned no row.')

        const item_id = itemRow.id

        // Optional photo upload
        const file = photo.files?.[0]
        let storage_key = null
        if (file) {
          const ext = (file.name.split('.').pop() || 'jpg').toLowerCase()
          storage_key = `${item_id}/${crypto.randomUUID()}.${ext}`
          const { error: upErr } = await supabase.storage.from('items').upload(storage_key, file, {
            contentType: file.type || 'image/jpeg',
            upsert: true
          })
          if (upErr) throw upErr
          const db_path = `items/${storage_key}`
          const { error: linkErr } = await supabase.schema('public').from('item_photo').insert({ item_id, path: db_path, sort_order: 0 })
          if (linkErr) throw linkErr
        }

        // Public URL (if any)
        let pubUrl = ''
        if (storage_key) {
          const { data: pub } = await supabase.storage.from('items').getPublicUrl(storage_key)
          pubUrl = pub?.publicUrl || ''
        }

        msg(insMsg, `Inserted
Item ID: ${item_id}${pubUrl ? `
Photo: ${pubUrl}` : ''}`, true)

        // reset fields
        title.value = ''; desc.value = ''; category_select.value = 'Electronics'; found_loc.value = ''; found_date.value = ''; photo.value=''
      } catch (e) {
        msg(insMsg, 'Insert failed: ' + (e?.message || e))
      }
    })
  </script>
</body>
</html>
